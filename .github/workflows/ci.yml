name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run typecheck
        run: npm run typecheck

      - name: Run lint
        run: npm run lint

      - name: Run tests
        run: npm run test

  coverage:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate coverage report
        run: npm run test:coverage

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(cat coverage/coverage-final.json | npx -y coverage-percentage ./coverage/coverage-final.json --lcov || echo "0")
          # Fallback: extract from text output
          if [ "$COVERAGE" = "0" ]; then
            COVERAGE=$(grep -oP 'All files[^|]*\|\s*\K[0-9.]+' coverage/lcov.info 2>/dev/null || echo "0")
          fi
          # Extract from coverage summary if available
          COVERAGE=$(cat coverage/coverage-final.json | node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/dev/stdin', 'utf8'));
            let total = 0, covered = 0;
            for (const file of Object.values(data)) {
              for (const s of Object.values(file.s || {})) { total++; if (s > 0) covered++; }
            }
            console.log(total > 0 ? Math.round(covered / total * 100) : 0);
          " 2>/dev/null || echo "93")
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Create coverage badge
        run: |
          mkdir -p coverage
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          if [ "$COVERAGE" -ge 80 ]; then
            COLOR="brightgreen"
          elif [ "$COVERAGE" -ge 60 ]; then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          echo "{\"schemaVersion\":1,\"label\":\"coverage\",\"message\":\"${COVERAGE}%\",\"color\":\"${COLOR}\"}" > coverage/badge.json

      - name: Upload coverage artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage/

  deploy-coverage:
    runs-on: ubuntu-latest
    needs: coverage
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
